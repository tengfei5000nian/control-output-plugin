{"version":3,"file":"index.js","names":["pluginName","defaultOptions","additionalProperties","properties","control","description","type","delOptions","verbose","defaultControlItemOptions","test","anyOf","instanceof","replace","ControlOutputPlugin","constructor","options","Object","assign","validate","forEach","item","outputPath","currentAssets","apply","compiler","output","path","console","warn","hooks","emit","tap","compilation","error","getStats","assets","assetsInfo","keys","name","newName","redirect","set","get","delete","done","stats","assetNames","removePatterns","filter","previousAsset","includes","length","remove","reduce","target","RegExp","indexOf","basename","patterns","deleted","del","sync","dot","force","dryRun","cwd","ignore","file","filename","relative","process","hasErrors"],"sources":["../src/index.js"],"sourcesContent":["import path from 'path'\nimport del from 'del'\nimport { validate } from 'schema-utils'\n\nconst pluginName = 'control-output-plugin'\n\nconst defaultOptions = {\n  additionalProperties: true,\n  properties: {\n    control: {\n      description: '资源输出路径控制',\n      type: 'array'\n    },\n    delOptions: {\n      description: 'del的options',\n      type: 'object'\n    },\n    verbose: {\n      description: '是否提示',\n      type: 'boolean'\n    }\n  },\n  type: 'object'\n}\n\nconst defaultControlItemOptions = {\n  additionalProperties: true,\n  properties: {\n    test: {\n      description: '资源路径匹配',\n      anyOf: [\n        {\n          type: 'string'\n        },\n        {\n          instanceof: 'Function'\n        },\n        {\n          instanceof: 'RegExp'\n        }\n      ]\n    },\n    replace: {\n      description: '资源路径替换',\n      anyOf: [\n        {\n          type: 'null'\n        },\n        {\n          type: 'string'\n        },\n        {\n          instanceof: 'Function'\n        }\n      ]\n    }\n  },\n  type: 'object'\n}\n\nexport default class ControlOutputPlugin {\n  constructor(options = {}) {\n    this.options = Object.assign({\n      control: [],\n      delOptions: {},\n      verbose: true\n    }, options)\n\n    validate(defaultOptions, this.options)\n\n    this.options.control.forEach(item => {\n      validate(defaultControlItemOptions, item)\n    })\n\n    this.outputPath = ''\n    this.currentAssets = []\n  }\n\n  apply(compiler) {\n    if (!compiler.options.output || !compiler.options.output.path) {\n      console.warn(`${pluginName}: options.output.path not defined. Plugin disabled...`)\n      return\n    }\n\n    this.outputPath = compiler.options.output.path\n\n    compiler.hooks.emit.tap(pluginName, compilation => {\n      // 判断是否编译错误\n      if (this.error(compilation.getStats())) return\n      // 替换路径\n      const assets = compilation.assets\n      const assetsInfo = compilation.assetsInfo\n      Object.keys(assets).forEach(name => {\n        const newName = this.redirect(name)\n        if (newName === name) return\n\n        if (newName) {\n          assets[newName] = assets[name]\n          assetsInfo.set(newName, assetsInfo.get(name))\n        }\n\n        delete assets[name]\n        assetsInfo.delete(name)\n      })\n    })\n\n    compiler.hooks.done.tap(pluginName, stats => {\n      // 判断是否编译错误\n      if (this.error(stats)) return\n      // 删除多余文件\n      const assetNames = Object.keys(stats.compilation.assets)\n      const removePatterns = this.currentAssets.filter(previousAsset => {\n        return assetNames.includes(previousAsset) === false\n      })\n      this.currentAssets = assetNames\n      removePatterns.length && this.remove(removePatterns)\n    })\n  }\n\n  redirect(name) {\n    return this.options.control.reduce((target, item) => {\n      return this.test(target, item.test)\n        ? this.replace(target, item.replace)\n        : target\n    }, name)\n  }\n\n  test(name, test) {\n    if (test instanceof RegExp) {\n      return test.test(name)\n    } else if (typeof test === 'function') {\n      return test(name)\n    } else if (typeof test === 'string') {\n      return ~name.indexOf(test)\n    } else {\n      return false\n    }\n  }\n\n  replace(name, replace) {\n    const basename = path.basename(name)\n    if (typeof replace === \"function\") {\n      return replace(name)\n    } else if (typeof replace === \"string\") {\n      return replace\n        .replace(/\\[basename\\]/g, basename)\n        .replace(/\\[resolvePath\\]/g, name)\n    } else {\n      return null\n    }\n  }\n\n  remove(patterns) {\n    const deleted = del.sync(patterns, Object.assign({\n      dot: true,\n      force: true,\n      dryRun: false,\n      cwd: this.outputPath,\n      ignore: this.currentAssets\n    }, this.options.delOptions))\n    \n    this.options.verbose && deleted.forEach(file => {\n      const filename = path.relative(process.cwd(), file)\n      console.warn(`${pluginName}: removed ${filename}`)\n    })\n  }\n\n  error(stats) {\n    if (stats.hasErrors()) {\n      this.options.verbose && console.warn(`${pluginName}: pausing due to webpack errors`)\n      return true\n    } else {\n      return false\n    }\n  }\n}\n"],"mappings":"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"}