{"version":3,"file":"index.js","names":["pluginName","defaultOptions","additionalProperties","properties","control","description","type","delOptions","verbose","defaultControlItemOptions","test","anyOf","instanceof","replace","ControlOutputPlugin","constructor","options","Object","assign","validate","forEach","item","outputPath","cachePath","path","join","process","cwd","getCache","apply","compiler","output","console","warn","hooks","thisCompilation","tap","compilation","afterProcessAssets","assets","keys","name","newName","redirect","renameAsset","deleteAsset","done","stats","error","assetNames","removePatterns","currentAssets","filter","previousAsset","includes","setCache","length","remove","reduce","target","RegExp","indexOf","basename","patterns","deleted","del","sync","dot","force","dryRun","ignore","file","filename","relative","hasErrors","fs","writeFile","encoding","err","readFileSync","toString","split"],"sources":["../src/index.js"],"sourcesContent":["import path from 'path'\nimport del from 'del'\nimport fs from 'fs'\nimport { validate } from 'schema-utils'\n\nconst pluginName = 'control-output-plugin'\n\nconst defaultOptions = {\n  additionalProperties: true,\n  properties: {\n    control: {\n      description: '资源输出路径控制',\n      type: 'array'\n    },\n    delOptions: {\n      description: 'del的options',\n      type: 'object'\n    },\n    verbose: {\n      description: '是否提示',\n      type: 'boolean'\n    }\n  },\n  type: 'object'\n}\n\nconst defaultControlItemOptions = {\n  additionalProperties: true,\n  properties: {\n    test: {\n      description: '资源路径匹配',\n      anyOf: [\n        {\n          type: 'string'\n        },\n        {\n          instanceof: 'Function'\n        },\n        {\n          instanceof: 'RegExp'\n        }\n      ]\n    },\n    replace: {\n      description: '资源路径替换',\n      anyOf: [\n        {\n          type: 'null'\n        },\n        {\n          type: 'string'\n        },\n        {\n          instanceof: 'Function'\n        }\n      ]\n    }\n  },\n  type: 'object'\n}\n\nexport default class ControlOutputPlugin {\n  constructor(options = {}) {\n    this.options = Object.assign({\n      control: [],\n      delOptions: {},\n      verbose: true\n    }, options)\n\n    validate(defaultOptions, this.options)\n\n    this.options.control.forEach(item => {\n      validate(defaultControlItemOptions, item)\n    })\n\n    this.outputPath = ''\n    this.cachePath = path.join(process.cwd(), '.control-output-plugin')\n    this.getCache()\n  }\n\n  apply(compiler) {\n    if (!compiler.options.output || !compiler.options.output.path) {\n      console.warn(`${pluginName}: options.output.path not defined. Plugin disabled...`)\n      return\n    }\n\n    this.outputPath = compiler.options.output.path\n\n    compiler.hooks.thisCompilation.tap(pluginName, compilation => {\n      compilation.hooks.afterProcessAssets.tap(pluginName, () => {\n        // 替换路径\n        const assets = compilation.assets\n        Object.keys(assets).forEach(name => {\n          const newName = this.redirect(name)\n          if (newName === name) return\n\n          if (newName) {\n            compilation.renameAsset(name, newName)\n          } else {\n            compilation.deleteAsset(name)\n          }\n        })\n      })\n    })\n\n    compiler.hooks.done.tap(pluginName, stats => {\n      // 判断是否编译错误\n      if (this.error(stats)) return\n      // 删除多余文件\n      const assetNames = Object.keys(stats.compilation.assets)\n      const removePatterns = this.currentAssets.filter(previousAsset => {\n        return assetNames.includes(previousAsset) === false\n      })\n      this.setCache(assetNames)\n      removePatterns.length && this.remove(removePatterns)\n    })\n  }\n\n  redirect(name) {\n    return this.options.control.reduce((target, item) => {\n      return this.test(target, item.test)\n        ? this.replace(target, item.replace)\n        : target\n    }, name)\n  }\n\n  test(name, test) {\n    if (test instanceof RegExp) {\n      return test.test(name)\n    } else if (typeof test === 'function') {\n      return test(name)\n    } else if (typeof test === 'string') {\n      return ~name.indexOf(test)\n    } else {\n      return false\n    }\n  }\n\n  replace(name, replace) {\n    const basename = path.basename(name)\n    if (typeof replace === \"function\") {\n      return replace(name)\n    } else if (typeof replace === \"string\") {\n      return replace\n        .replace(/\\[basename\\]/g, basename)\n        .replace(/\\[resolvePath\\]/g, name)\n    } else {\n      return null\n    }\n  }\n\n  remove(patterns) {\n    const deleted = del.sync(patterns, Object.assign({\n      dot: true,\n      force: true,\n      dryRun: false,\n      cwd: this.outputPath,\n      ignore: this.currentAssets\n    }, this.options.delOptions))\n    \n    this.options.verbose && deleted.forEach(file => {\n      const filename = path.relative(process.cwd(), file)\n      console.warn(`${pluginName}: removed ${filename}`)\n    })\n  }\n\n  error(stats) {\n    if (stats.hasErrors()) {\n      this.options.verbose && console.warn(`${pluginName}: pausing due to webpack errors`)\n      return true\n    } else {\n      return false\n    }\n  }\n\n  setCache(assets) {\n    this.currentAssets = assets\n    fs.writeFile(this.cachePath, assets.join('\\n'), {\n      encoding: 'utf8'\n    }, err => {\n      this.options.verbose && err && console.error(err)\n    })\n  }\n\n  getCache() {\n    try {\n      this.currentAssets = fs.readFileSync(this.cachePath, {\n        encoding: 'utf8'\n      }).toString().split(/\\n+/)\n    } catch (err) {\n      this.currentAssets = []\n    }\n  }\n}\n"],"mappings":"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"}